<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes List</title>
</head>
<body>
    <h2>All Notes</h2>

    <!-- Navigation Buttons -->
    <a href="{% url 'create_note' %}"><button>Create New Note</button></a>
    <a href="{% url 'profile_view' %}"><button>Go to Profile</button></a>

    <!-- Search Form -->
    <form method="GET" action="{% url 'notes_list' %}">
        <label for="grade_level">Filter by Grade:</label>
        <select name="grade_level">
            <option value="">All Grades</option>
            {% for grade_value, grade_label in GRADE_CHOICES %}
                <option value="{{ grade_value }}" {% if grade_filter == grade_value %}selected{% endif %}>{{ grade_label }}</option>
            {% endfor %}
        </select>

        <label for="subject">Filter by Subject:</label>
        <select name="subject">
            <option value="">All Subjects</option>
            {% for subject_value, subject_label in SUBJECT_CHOICES %}
                <option value="{{ subject_value }}" {% if subject_filter == subject_value %}selected{% endif %}>{{ subject_label }}</option>
            {% endfor %}
        </select>

        <label for="username">Search by Username:</label>
        <input type="text" name="username" value="{{ username_filter }}" placeholder="Enter username">
        <button type="submit">Search</button>
    </form>

    <!-- Notes List with Full Details -->
    <ul>
        {% for note in notes %}
            <li>
                <h3>{{ note.title }}</h3>
                <p><strong>Grade:</strong> {{ note.grade_level }} | <strong>Subject:</strong> {{ note.subject }}</p>  

                <!-- Author Profile Link -->
                <p>
                    <a href="{% url 'public_profile' note.author.username %}">
                        {% if note.author.profile_picture %}
                            <img src="{{ note.author.profile_picture.url }}" alt="Profile Picture" width="50">
                        {% endif %}
                        <strong>{{ note.author.username }}</strong>
                    </a>
                </p>

                <!-- Note Content -->
                <p>{{ note.content }}</p>

                <!-- File Download Option -->
                {% if note.file %}
                    <p><a href="{{ note.file.url }}" download><button>üì• Download Attachment</button></a></p>
                {% endif %}

                <!-- Like & Dislike Buttons -->
                <form method="POST" action="{% url 'notes_list' %}">
                    {% csrf_token %}
                    <input type="hidden" name="note_id" value="{{ note.id }}">
                    <button type="submit" name="action" value="like">üëç Like ({{ note.likes.count }})</button>
                    <button type="submit" name="action" value="dislike">üëé Dislike ({{ note.dislikes.count }})</button>
                </form>

                <!-- Comments Section -->
                <h4>Comments</h4>
                <ul>
                    {% for comment in note.comments.all %}
                        <li>
                            <strong>{{ comment.user.username }}:</strong> {{ comment.content }}

                            <!-- Reply Form -->
                            <form method="POST" action="{% url 'notes_list' %}">
                                {% csrf_token %}
                                <input type="hidden" name="note_id" value="{{ note.id }}">
                                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                <input type="hidden" name="action" value="comment">
                                <input type="text" name="content" placeholder="Write a reply..." required>
                                <button type="submit">Reply</button>
                            </form>

                            <!-- Display Replies -->
                            <ul>
                                {% for reply in comment.replies.all %}
                                    <li><strong>{{ reply.user.username }}:</strong> {{ reply.content }}</li>
                                {% endfor %}
                            </ul>
                        </li>
                    {% empty %}
                        <p>No comments yet.</p>
                    {% endfor %}
                </ul>

                <!-- Add Comment Form -->
                <form method="POST" action="{% url 'notes_list' %}">
                    {% csrf_token %}
                    <input type="hidden" name="note_id" value="{{ note.id }}">
                    <input type="hidden" name="action" value="comment">
                    <input type="text" name="content" placeholder="Write a comment..." required>
                    <button type="submit">Comment</button>
                </form>

                <!-- Edit & Delete Options for Note Author -->
                {% if note.author == request.user %}
                    <a href="{% url 'edit_note' note.id %}">Edit</a> |
                    <a href="{% url 'delete_note' note.id %}">Delete</a>
                {% endif %}
            </li>
        {% empty %}
            <p>No notes available.</p>  
        {% endfor %}
    </ul>
</body>
</html>
